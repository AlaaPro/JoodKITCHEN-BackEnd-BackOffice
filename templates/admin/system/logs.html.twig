{% extends 'admin/base.html.twig' %}

{% block title %}Logs Système - JoodKitchen Admin{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Accueil</a></li>
<li class="breadcrumb-item active">Logs Système</li>
{% endblock %}

{% block content %}
<!-- System Logs Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-0 jood-dark">Logs Système</h1>
                <p class="text-muted">Surveillez l'activité et les erreurs du système</p>
            </div>
            <div>
                <button class="btn btn-primary me-2" id="refreshLogs">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
                <button class="btn btn-outline-primary" data-coreui-toggle="modal" data-coreui-target="#exportLogsModal">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Stats -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-info-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" data-stat="logs-today">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </div>
                        <div class="widget-label">Logs aujourd'hui</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-file-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-secondary-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" data-stat="errors">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </div>
                        <div class="widget-label">Erreurs</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-warning-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" data-stat="warnings">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </div>
                        <div class="widget-label">Avertissements</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-primary-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" data-stat="info">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </div>
                        <div class="widget-label">Info</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Filters -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Filtres des Logs</h4>
            <button class="btn btn-outline-secondary btn-sm" id="toggleFilters">
                <i class="fas fa-filter"></i> Filtres
            </button>
        </div>
    </div>
    <div class="card-body" id="filtersPanel">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Niveau</label>
                <select class="form-select" id="logLevel">
                    <option value="">Tous les niveaux</option>
                    <option value="error">Erreur</option>
                    <option value="warning">Avertissement</option>
                    <option value="info">Information</option>
                    <option value="debug">Debug</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Composant</label>
                <select class="form-select" id="logComponent">
                    <option value="">Tous les composants</option>
                    <option value="auth">Authentification</option>
                    <option value="orders">Commandes</option>
                    <option value="kitchen">Cuisine</option>
                    <option value="customers">Clients</option>
                    <option value="payment">Paiement</option>
                    <option value="menu">Menus</option>
                    <option value="admin">Administration</option>
                    <option value="security">Sécurité</option>
                    <option value="system">Système</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Date début</label>
                <input type="datetime-local" class="form-control" id="dateStart">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date fin</label>
                <input type="datetime-local" class="form-control" id="dateEnd">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-outline-secondary" id="clearFilters">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Logs -->
<div class="row g-4">
    <!-- Logs Table -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-stream"></i> Logs en Temps Réel
                    </h4>
                    <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                            <label class="form-check-label" for="autoRefresh">
                                Auto-actualisation
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="log-container" style="height: 600px; overflow-y: auto; font-family: 'Courier New', monospace;">
                    <div id="logsContent">
                        <div class="text-center text-muted py-5">
                            <span class="spinner-border" role="status"></span>
                            <div class="mt-2">Chargement des logs en temps réel...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Analytics -->
    <div class="col-lg-4">
        <!-- Recent Errors -->
        <div class="card mb-4">
            <div class="card-header jood-secondary-bg">
                <h5 class="card-title mb-0 text-white">
                    <i class="fas fa-bug"></i> Erreurs Récentes
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush recent-errors-list">
                    <div class="text-center text-muted py-3">
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        Chargement des erreurs...
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health -->
        {# <div class="card mb-4">
            <div class="card-header jood-primary-bg">
                <h5 class="card-title mb-0 text-white">
                    <i class="fas fa-heartbeat"></i> Santé du Système
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>CPU</span>
                    <div>
                        <span class="fw-bold jood-primary" data-health="cpu">--%</span>
                        <div class="progress mt-1" style="height: 4px; width: 60px;">
                            <div class="progress-bar jood-primary-bg" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Mémoire</span>
                    <div>
                        <span class="fw-bold jood-warning" data-health="memory">--%</span>
                        <div class="progress mt-1" style="height: 4px; width: 60px;">
                            <div class="progress-bar jood-warning-bg" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Disque</span>
                    <div>
                        <span class="fw-bold jood-primary" data-health="disk">--%</span>
                        <div class="progress mt-1" style="height: 4px; width: 60px;">
                            <div class="progress-bar jood-primary-bg" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Réseau</span>
                    <div>
                        <span class="fw-bold jood-primary" data-health="network">--%</span>
                        <div class="progress mt-1" style="height: 4px; width: 60px;">
                            <div class="progress-bar jood-primary-bg" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div> #}

        <!-- Log Distribution -->
        <div class="card">
            <div class="card-header jood-info-bg">
                <h5 class="card-title mb-0 text-white">
                    <i class="fas fa-chart-pie"></i> Répartition (24h)
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        <span>Info</span>
                    </div>
                    <span class="fw-bold" data-distribution="info">--%</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <i class="fas fa-exclamation-circle jood-warning me-2"></i>
                        <span>Warning</span>
                    </div>
                    <span class="fw-bold" data-distribution="warning">--%</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <i class="fas fa-exclamation-triangle jood-secondary me-2"></i>
                        <span>Error</span>
                    </div>
                    <span class="fw-bold" data-distribution="error">--%</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-bug text-dark me-2"></i>
                        <span>Debug</span>
                    </div>
                    <span class="fw-bold" data-distribution="debug">--%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Logs Modal -->
<div class="modal fade" id="exportLogsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header jood-primary-bg">
                <h5 class="modal-title text-white">
                    <i class="fas fa-download"></i> Exporter les Logs
                </h5>
                <button type="button" class="btn-close btn-close-white" data-coreui-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportLogsForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Format d'export</label>
                            <select class="form-select" name="format">
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                                <option value="txt">Fichier texte</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date début</label>
                            <input type="date" class="form-control" name="dateStart">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date fin</label>
                            <input type="date" class="form-control" name="dateEnd">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Niveaux à inclure</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportError" name="exportError" checked>
                                <label class="form-check-label" for="exportError">Erreurs</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportWarning" name="exportWarning" checked>
                                <label class="form-check-label" for="exportWarning">Avertissements</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportInfo" name="exportInfo">
                                <label class="form-check-label" for="exportInfo">Informations</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportDebug" name="exportDebug">
                                <label class="form-check-label" for="exportDebug">Debug</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<!-- Include the logs API JavaScript -->
<script src="{{ asset('js/admin/logs-api.js') }}"></script>

<!-- Enhanced export modal functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Export logs functionality
    const exportButton = document.querySelector('#exportLogsModal .btn-primary');
    if (exportButton) {
        exportButton.addEventListener('click', async function() {
            const modal = coreui.Modal.getInstance(document.getElementById('exportLogsModal'));
            const form = document.getElementById('exportLogsForm');
            const formData = new FormData(form);
            
            const filters = {};
            const format = formData.get('format') || 'csv';
            
            // Get current applied filters
            if (window.logsManager && window.logsManager.currentFilters) {
                Object.assign(filters, window.logsManager.currentFilters);
            }
            
            // Add date range from export form
            if (formData.get('dateStart')) filters.dateStart = formData.get('dateStart');
            if (formData.get('dateEnd')) filters.dateEnd = formData.get('dateEnd');
            
            // Add log levels to include
            const levels = [];
            if (formData.get('exportError')) levels.push('error');
            if (formData.get('exportWarning')) levels.push('warning');
            if (formData.get('exportInfo')) levels.push('info');
            if (formData.get('exportDebug')) levels.push('debug');
            
            if (levels.length > 0) {
                filters.levels = levels;
            }
            
            try {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Export en cours...';
                this.disabled = true;
                
                const api = new LogsAPI();
                const exportData = await api.exportLogs(filters, format);
                
                // Create download
                if (format === 'csv') {
                    downloadCSV(exportData.data, `joodkitchen-logs-${new Date().toISOString().split('T')[0]}.csv`);
                } else if (format === 'json') {
                    downloadJSON(exportData.data, `joodkitchen-logs-${new Date().toISOString().split('T')[0]}.json`);
                } else if (format === 'txt') {
                    downloadText(exportData.data, `joodkitchen-logs-${new Date().toISOString().split('T')[0]}.txt`);
                }
                
                modal.hide();
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Erreur lors de l\'export: ' + error.message);
            } finally {
                this.innerHTML = '<i class="fas fa-download"></i> Exporter';
                this.disabled = false;
            }
        });
    }
    
    // Download helper functions
    function downloadCSV(csvData, filename) {
        const csvContent = csvData.map(row => row.join(',')).join('\n');
        downloadFile(csvContent, filename, 'text/csv');
    }
    
    function downloadJSON(jsonData, filename) {
        const jsonContent = JSON.stringify(jsonData, null, 2);
        downloadFile(jsonContent, filename, 'application/json');
    }
    
    function downloadText(textData, filename) {
        downloadFile(textData, filename, 'text/plain');
    }
    
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
});
</script>
{% endblock %} 