{% extends 'admin/base.html.twig' %}

{% block title %}Administrateurs - JoodKitchen Admin{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ path('admin_dashboard') }}">Accueil</a></li>
<li class="breadcrumb-item"><a href="{{ path('admin_clients') }}">Clients</a></li>
<li class="breadcrumb-item active">Administrateurs</li>
{% endblock %}

{% block content %}
<!-- Admins Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-0 jood-dark">Gestion des Administrateurs</h1>
                <p class="text-muted">G√©rez les comptes administrateurs et leurs permissions</p>
            </div>
            <div>
                {% if is_granted('manage_admins') %}
                <button class="btn btn-primary me-2" id="createAdminBtn">
                    <i class="fas fa-user-shield"></i> Nouvel Administrateur
                </button>
                {% endif %}
                {% if is_granted('manage_permissions') %}
                <button class="btn btn-outline-primary" id="managePermissionsBtn">
                    <i class="fas fa-key"></i> Permissions
                </button>
                {% endif %}
                {% if is_granted('view_admins') %}
                <button class="btn btn-outline-success" id="exportAdminsBtn">
                    <i class="fas fa-download"></i> Exporter
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Security Alert -->
{% if is_granted('ROLE_SUPER_ADMIN') %}
<div class="alert alert-warning mb-4">
    <div class="d-flex align-items-center">
        <i class="fas fa-shield-alt me-3 fs-4"></i>
        <div>
            <strong>Zone de s√©curit√© √©lev√©e</strong><br>
            <small>Seuls les Super Administrateurs peuvent g√©rer les comptes administrateurs. Toutes les actions sont journalis√©es.</small>
        </div>
    </div>
</div>
{% endif %}

<!-- Admin Stats -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-secondary-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" id="superAdminCount">-</div>
                        <div class="widget-label">Super Admin</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-crown fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-primary-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" id="totalAdmins">-</div>
                        <div class="widget-label">Administrateurs</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-shield fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-success-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" id="activeAdmins">-</div>
                        <div class="widget-label">Actifs</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-sm-6">
        <div class="card jood-widget-card jood-warning-bg">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="widget-value" id="suspendedAdmins">-</div>
                        <div class="widget-label">Suspendu</div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-times fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loadingState" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-3 text-muted">Chargement des administrateurs...</p>
</div>

<!-- Administrators List -->
<div class="card" id="adminTableCard">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">
                <i class="fas fa-users-cog"></i> Liste des Administrateurs
            </h4>
            <div class="d-flex align-items-center gap-2">
                <select class="form-select form-select-sm" id="roleFilter" style="width: auto;">
                    <option value="">Tous les niveaux</option>
                    <option value="ROLE_SUPER_ADMIN">Super Admin</option>
                    <option value="ROLE_ADMIN">Administrateur</option>
                </select>
                <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
                    <option value="">Tous les statuts</option>
                    <option value="active">Actif</option>
                    <option value="inactive">Inactif</option>
                </select>
                <input type="text" class="form-control form-control-sm" id="adminSearchInput" placeholder="Rechercher..." style="width: 200px;">
                <button class="btn btn-outline-secondary btn-sm" id="resetFiltersBtn">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="adminsTable">
                <thead class="table-light">
                    <tr>
                        <th>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllAdmins">
                            </div>
                        </th>
                        <th>Administrateur</th>
                        <th>Niveau</th>
                        <th>Statut</th>
                        <th>Derni√®re connexion</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Enhanced CRUD Modals for AdminProfile -->
{{ include('components/modals/admin-profile-modals.html.twig') }}

<script>
// Initialize AdminProfile Manager when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the AdminProfile CRUD manager
    window.adminProfileManager = new AdminProfileManager();
    
    console.log('üöÄ AdminProfile CRUD Manager initialized with new permission system integration');
    
    // Connect header buttons based on permissions
    {% if is_granted('manage_admins') %}
    // Create button is already handled by AdminProfileManager
    console.log('‚úÖ Create admin permissions granted');
    {% endif %}
    
    {% if is_granted('manage_permissions') %}
    document.getElementById('managePermissionsBtn').addEventListener('click', () => {
        // Redirect to permission management interface
        window.location.href = '{{ path('admin_dashboard') }}#permissions';
    });
    {% else %}
    // Hide permissions button if no access
    const permBtn = document.getElementById('managePermissionsBtn');
    if (permBtn) permBtn.style.display = 'none';
    {% endif %}
    
    {% if is_granted('view_admins') %}
    document.getElementById('exportAdminsBtn').addEventListener('click', () => {
        adminProfileManager.exportAdmins();
    });
    {% else %}
    // Hide export button if no access
    const exportBtn = document.getElementById('exportAdminsBtn');
    if (exportBtn) exportBtn.style.display = 'none';
    {% endif %}
    
    // Connect search and filters
    document.getElementById('adminSearchInput').addEventListener('input', (e) => {
        adminProfileManager.filterAdmins({
            search: e.target.value,
            role: document.getElementById('roleFilter').value,
            status: document.getElementById('statusFilter').value
        });
    });
    
    document.getElementById('roleFilter').addEventListener('change', (e) => {
        adminProfileManager.filterAdmins({
            search: document.getElementById('adminSearchInput').value,
            role: e.target.value,
            status: document.getElementById('statusFilter').value
        });
    });
    
    document.getElementById('statusFilter').addEventListener('change', (e) => {
        adminProfileManager.filterAdmins({
            search: document.getElementById('adminSearchInput').value,
            role: document.getElementById('roleFilter').value,
            status: e.target.value
        });
    });
    
    document.getElementById('resetFiltersBtn').addEventListener('click', () => {
        document.getElementById('adminSearchInput').value = '';
        document.getElementById('roleFilter').value = '';
        document.getElementById('statusFilter').value = '';
        adminProfileManager.loadAdminProfiles();
    });
    
    // Connect select all checkbox
    document.getElementById('selectAllAdmins').addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.admin-select-checkbox');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
    });
    
    // AdminProfileManager automatically loads data in constructor
    // No need to call loadAdminProfiles() again
});

// Global helper functions for permission-aware UI
window.AdminPermissions = {
    // Current user's permissions (populated from backend)
    userPermissions: {% if app.user and app.user.adminProfile and app.user.adminProfile.allPermissionNames %}{{ app.user.adminProfile.allPermissionNames|json_encode|raw }}{% else %}[]{% endif %},
    
    // Check if current user has specific permission
    hasPermission: function(permission) {
        return this.userPermissions.includes(permission) || {{ is_granted('ROLE_SUPER_ADMIN') ? 'true' : 'false' }};
    },
    
    // Check if user can edit specific admin
    canEdit: function(targetUserRoles) {
        if ({{ is_granted('ROLE_SUPER_ADMIN') ? 'true' : 'false' }}) return true;
        if (targetUserRoles.includes('ROLE_SUPER_ADMIN')) return false;
        return this.hasPermission('edit_admin_user');
    },
    
    // Check if user can delete specific admin
    canDelete: function(targetUserRoles) {
        if ({{ is_granted('ROLE_SUPER_ADMIN') ? 'true' : 'false' }}) return true;
        if (targetUserRoles.includes('ROLE_SUPER_ADMIN')) return false;
        return this.hasPermission('delete_admin_user');
    }
};

console.log('üîê Permission system initialized:', window.AdminPermissions);
</script>

<!-- Recent Activity -->
<div class="row g-4 mt-2">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header jood-info-bg">
                <h5 class="card-title mb-0 text-white">
                    <i class="fas fa-history"></i> Activit√© R√©cente
                </h5>
            </div>
            <div class="card-body">
                <div class="activity-timeline" id="activityTimeline">
                    <!-- Dynamic content will be loaded here -->
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-clock"></i> Chargement de l'activit√©...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header jood-secondary-bg">
                <h5 class="card-title mb-0 text-white">
                    <i class="fas fa-shield-alt"></i> S√©curit√©
                </h5>
            </div>
            <div class="card-body">
                <div class="security-metrics" id="securityMetrics">
                    <!-- Dynamic content will be loaded here -->
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-shield-alt"></i> Chargement des m√©triques de s√©curit√©...
                    </div>
                </div>
                
                <hr>
                
                <div class="d-grid gap-2">
                    {% if is_granted('manage_system') %}
                    <button class="btn btn-outline-primary btn-sm" onclick="AdminPermissions.showSecurityAudit()">
                        <i class="fas fa-shield-alt"></i> Audit s√©curit√©
                    </button>
                    {% endif %}
                    {% if is_granted('manage_admins') %}
                    <button class="btn btn-outline-warning btn-sm" onclick="AdminPermissions.forcePasswordReset()">
                        <i class="fas fa-key"></i> Forcer nouveau mot de passe
                    </button>
                    {% endif %}
                    {% if is_granted('view_activity_logs') %}
                    <button class="btn btn-outline-info btn-sm" onclick="AdminPermissions.showConnectionLog()">
                        <i class="fas fa-history"></i> Journal des connexions
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Permission Matrix Modal (if user has permission) -->
{% if is_granted('view_permission_matrix') %}
<div class="modal fade" id="permissionMatrixModal" tabindex="-1" aria-labelledby="permissionMatrixModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="permissionMatrixModalLabel">
                    <i class="fas fa-table"></i> Matrice des Permissions
                </h5>
                <button type="button" class="btn-close" data-coreui-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="permissionMatrix">
                    <!-- Dynamic permission matrix will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}